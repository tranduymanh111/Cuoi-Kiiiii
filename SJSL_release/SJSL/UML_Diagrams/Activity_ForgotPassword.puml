@startuml Activity_ForgotPassword
!theme plain
skinparam backgroundColor #FFFFFF
skinparam activity {
    BackgroundColor #E8F4FD
    BorderColor #2E86AB
    FontColor #2E86AB
}

title Biểu đồ Hoạt động - Quy trình Quên Mật khẩu

start

:Người dùng nhập email;

:Frontend validate email format;

if (Email hợp lệ?) then (Có)
    :Gửi request quên mật khẩu;
    
    :Backend nhận request;
    :Validate email input;
    
    if (Email hợp lệ?) then (Có)
        :Tìm user trong database;
        
        if (User tồn tại?) then (Có)
            :Tạo reset token;
            :Set expiration time (24h);
            :Hash token;
            
            :Lưu token vào database;
            
            if (Lưu token thành công?) then (Có)
                :Tạo reset URL;
                :Chuẩn bị email template;
                :Thêm reset link vào email;
                
                :Gửi email reset;
                
                if (Gửi email thành công?) then (Có)
                    :Trả về thông báo thành công;
                    
                    :Frontend nhận response;
                    :Hiển thị thông báo;
                    :Hướng dẫn kiểm tra email;
                    
                    stop
                else (Không)
                    :Xóa token đã tạo;
                    :Trả về lỗi "Không thể gửi email";
                endif
            else (Không)
                :Trả về lỗi "Không thể tạo token";
            endif
        else (Không)
            :Trả về thông báo "Email không tồn tại";
            note right
              Không tiết lộ thông tin
              về việc email có tồn tại hay không
            end note
        endif
    else (Không)
        :Trả về lỗi "Email không hợp lệ";
    endif
else (Không)
    :Hiển thị lỗi "Email không đúng định dạng";
endif

:Frontend hiển thị thông báo;

stop

note right of "Tạo reset token"
  - UUID v4
  - 24 giờ hết hạn
  - Hash trước khi lưu
end note

note right of "Tạo reset URL"
  - https://app.com/reset?token=xxx
  - Token được encode
  - Secure URL
end note

note right of "Gửi email reset"
  - SMTP configuration
  - HTML template
  - Fallback text
end note

@enduml 